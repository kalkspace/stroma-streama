<html>
  <head></head>
  <body>
    <h3>Audio:</h3>

    <button id="startButton" style="display: block">Start Receiving</button>

    <audio id="player" controls autoplay></audio>

    <div id="logs"></div>

    <script>
      let pc = new RTCPeerConnection({
        iceServers: [
          {
            urls: "stun:stun.l.google.com:19302",
          },
        ],
      });

      const logContainer = document.getElementById("logs");
      let log = (msg) => {
        console.log(msg);
        logContainer.innerHTML += msg + "<br>";
      };

      const player = document.getElementById("player");
      pc.ontrack = function (event) {
        const track = event.streams[0];
        console.debug("received track", { event, track });
        player.srcObject = track;
      };

      pc.oniceconnectionstatechange = (e) => log(pc.iceConnectionState);
      let sessionDescription = null;
      pc.onicecandidate = (event) => {
        console.debug("got ice candidate", { candidate: event.candidate });
        if (event.candidate === null) {
          console.debug("ice candidate succeeded");
          sessionDescription = pc.localDescription;
        }
      };

      // Offer to receive 1 audio
      pc.addTransceiver("audio", {
        direction: "sendrecv",
      });

      pc.createOffer()
        .then((d) => {
          console.debug("setting local description", d);
          pc.setLocalDescription(d);
        })
        .catch(log);

      const startSession = async () => {
        const response = await fetch(
          "https://marcus.stromaproxy.kalk.space/sdp",
          {
            method: "POST",
            headers: {
              "content-type": "application/json",
            },
            body: JSON.stringify(sessionDescription),
          }
        );

        if (!response.ok) {
          log(`http request failed: ${response.statusCode}`);
          return;
        }

        const remoteSession = await response.json();

        try {
          pc.setRemoteDescription(new RTCSessionDescription(remoteSession));
        } catch (e) {
          alert(e);
        }
      };

      document
        .getElementById("startButton")
        .addEventListener("click", startSession);
    </script>
  </body>
</html>
